<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Library OS - Gateway</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        body {
            background-color: #050505;
            font-family: 'Space Mono', monospace;
            color: white;
            overflow: hidden;
            margin: 0;
        }

        #aurora-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            opacity: 0.6;
        }

        .glass-panel {
            background: rgba(10, 10, 12, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .cyber-input {
            width: 100%; background: transparent; border: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 12px 0; font-family: 'Space Mono', monospace;
            color: white; font-size: 1.1rem; transition: all 0.3s; border-radius: 0;
        }
        .cyber-input:focus {
            outline: none; border-bottom-color: #22d3ee;
            box-shadow: 0 10px 20px -10px rgba(34, 211, 238, 0.1);
        }
        .cyber-input::placeholder { color: rgba(255, 255, 255, 0.2); font-size: 0.9rem; }
        .cyber-input.error { border-bottom-color: #ef4444; } /* Красный бордер при ошибке */

        .btn-primary {
            background: #22d3ee; color: #000; font-weight: bold; border-radius: 99px;
            padding: 10px 24px; transition: all 0.3s; cursor: pointer; display: inline-block;
        }
        .btn-primary:hover {
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.6); transform: translateY(-1px);
        }
        .btn-primary:disabled {
            opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: none;
        }

        /* Stepper Styles */
        .step-circle {
            width: 2.5rem; height: 2.5rem; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; transition: all 0.3s ease; position: relative; z-index: 10;
        }
        .connector-bg {
            position: absolute; top: 50%; left: 0; width: 100%; height: 2px;
            background: rgba(255, 255, 255, 0.1); transform: translateY(-50%); z-index: 0;
        }
        .connector-fill {
            position: absolute; top: 50%; left: 0; height: 2px;
            background: #22d3ee; transform: translateY(-50%); z-index: 0;
            width: 0%; transition: width 0.4s ease;
        }
        #steps-wrapper {
            position: relative; width: 100%; min-height: 200px; 
            overflow: hidden; transition: height 0.4s ease-out;
        }
        .step-slide {
            position: absolute; top: 0; left: 0; width: 100%;
            opacity: 0; visibility: hidden; will-change: transform, opacity;
        }
        .step-slide.active {
            opacity: 1; visibility: visible; position: relative;
        }
        .checkmark path { stroke-dasharray: 20; stroke-dashoffset: 20; }
        .step-circle.completed .checkmark path { animation: drawCheck 0.3s forwards 0.1s; }
        @keyframes drawCheck { to { stroke-dashoffset: 0; } }
    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center relative">

    <div id="aurora-container"></div>

    <div class="glass-panel w-full max-w-lg rounded-3xl p-8 relative overflow-hidden z-10" id="main-card">
        
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold tracking-tighter mb-1" id="header-title">SYSTEM_GATEWAY</h1>
            <p class="text-xs text-white/40 tracking-widest" id="header-subtitle">AUTHENTICATION REQUIRED</p>
        </div>

        <div id="views-wrapper" class="relative min-h-[300px]">
            
            <div id="view-login" class="view-section absolute top-0 left-0 w-full">
                <form onsubmit="return false;" class="space-y-6 pt-2">
                    <div>
                        <label class="text-[10px] text-cyan-400 font-mono tracking-widest block mb-1">EMAIL</label>
                        <input type="text" id="login-email" class="cyber-input" placeholder="Enter email" autocomplete="off">
                    </div>
                    <div>
                        <label class="text-[10px] text-cyan-400 font-mono tracking-widest block mb-1">PASSPHRASE</label>
                        <input type="password" id="login-pass" class="cyber-input" placeholder="••••••••••••" maxlength="70">
                    </div>
                    
                    <div class="pt-4">
                        <button onclick="handleLogin()" class="btn-primary w-full shadow-[0_0_20px_rgba(34,211,238,0.3)]">
                            ENTER_SYSTEM
                        </button>
                    </div>

                    <div class="text-center pt-4 border-t border-white/10 mt-6">
                        <p class="text-xs text-white/40 mb-3">NO IDENTITY FOUND?</p>
                        <button onclick="switchMode('register')" class="text-xs text-cyan-400 tracking-widest border border-cyan-400/30 px-4 py-2 rounded hover:bg-cyan-400/10 transition-colors">
                            INITIALIZE_NEW_PROTOCOL ->
                        </button>
                    </div>
                </form>
            </div>

            <div id="view-register" class="view-section absolute top-0 left-0 w-full opacity-0 translate-x-[110%] pointer-events-none">
                
                <div class="relative w-full px-6 mb-8">
                    <div class="connector-bg"></div>
                    <div id="connector-fill" class="connector-fill"></div>
                    <div class="relative flex justify-between z-10">
                        <div class="step-indicator" data-step="1"><div class="step-circle bg-gray-900 text-white border border-white/20">1</div></div>
                        <div class="step-indicator" data-step="2"><div class="step-circle bg-gray-900 text-white/40 border border-white/10">2</div></div>
                        <div class="step-indicator" data-step="3"><div class="step-circle bg-gray-900 text-white/40 border border-white/10">3</div></div>
                    </div>
                </div>

                <div id="steps-wrapper" class="relative min-h-[220px]">
                    <div class="step-slide active" data-step="1">
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] text-cyan-400 font-mono tracking-widest block mb-1">FULL_NAME</label>
                                <input type="text" id="reg-name" class="cyber-input" placeholder="Enter designation...">
                            </div>
                            <div>
                                <label class="text-[10px] text-cyan-400 font-mono tracking-widest block mb-1">EMAIL_ADDRESS</label>
                                <input type="email" id="reg-email" class="cyber-input" placeholder="user@domain.net">
                            </div>
                        </div>
                    </div>
                    
                    <div class="step-slide" data-step="2">
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] text-cyan-400 font-mono tracking-widest block mb-1">PASSPHRASE</label>
                                <input type="password" id="reg-pass" class="cyber-input" placeholder="••••••••••••" maxlength="70">
                            </div>
                            <div>
                                <label class="text-[10px] text-cyan-400 font-mono tracking-widest block mb-1">CONFIRM</label>
                                <input type="password" id="reg-confirm" class="cyber-input" placeholder="••••••••••••" maxlength="70">
                            </div>
                        </div>
                    </div>

                    <div class="step-slide" data-step="3">
                        <div class="space-y-5">
                            <p class="text-xs text-white/50 mb-2">Review protocol data before initialization.</p>
                            
                            <div class="bg-white/5 p-4 rounded-xl border border-white/10 space-y-3">
                                <div>
                                    <span class="text-[9px] text-white/30 tracking-widest block">IDENTITY</span>
                                    <span id="summary-name" class="text-sm font-bold text-white">Loading...</span>
                                </div>
                                <div>
                                    <span class="text-[9px] text-white/30 tracking-widest block">COMMUNICATION</span>
                                    <span id="summary-email" class="text-sm font-bold text-cyan-400">Loading...</span>
                                </div>
                                <div>
                                    <span class="text-[9px] text-white/30 tracking-widest block">CLEARANCE LEVEL</span>
                                    <div class="flex items-center gap-2 mt-1">
                                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                                        <span class="text-xs font-mono">STANDARD USER</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center mt-6 pt-4 border-t border-white/10">
                    <button id="btn-back" class="text-xs text-white/40 hover:text-white transition-colors">
                        < BACK
                    </button>
                    <button id="btn-next" class="btn-primary text-sm px-6 py-2">
                        CONTINUE
                    </button>
                </div>
                
                <div class="mt-4 text-center">
                    <button onclick="switchMode('login')" class="text-[10px] text-white/30 hover:text-cyan-400 transition-colors">
                        CANCEL_PROTOCOL // RETURN TO LOGIN
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script>
        const DOM = {
            viewWrapper: document.getElementById('views-wrapper'),
            loginView: document.getElementById('view-login'),
            registerView: document.getElementById('view-register'),
            headerTitle: document.getElementById('header-title'),
            headerSub: document.getElementById('header-subtitle')
        };

        const UI_OFFSET = 280; 

        // --- 1. ПЕРЕКЛЮЧЕНИЕ МЕЖДУ LOGIN И REGISTER ---
        function switchMode(mode) {
            const tl = gsap.timeline();

            if (mode === 'register') {
                tl.to(DOM.loginView, { x: '-110%', opacity: 0, duration: 0.4, ease: "power2.inOut" })
                  .set(DOM.registerView, { pointerEvents: 'auto' }, "<")
                  .to(DOM.registerView, { x: '0%', opacity: 1, duration: 0.4, ease: "power2.inOut" }, "-=0.3");

                const firstStep = document.querySelector('.step-slide[data-step="1"]');
                const slideHeight = firstStep ? firstStep.scrollHeight : 200;
                
                tl.to(DOM.viewWrapper, { height: slideHeight + UI_OFFSET, duration: 0.4, ease: "power2.out" }, "<");

                DOM.headerTitle.innerText = "ACCESS_PROTOCOL";
                DOM.headerSub.innerText = "ESTABLISHING NEW CONNECTION";

            } else {
                tl.to(DOM.registerView, { x: '110%', opacity: 0, duration: 0.4, ease: "power2.inOut" })
                  .set(DOM.registerView, { pointerEvents: 'none' })
                  .to(DOM.loginView, { x: '0%', opacity: 1, duration: 0.4, ease: "power2.inOut" }, "-=0.3");

                const loginHeight = DOM.loginView.scrollHeight + 20; 
                tl.to(DOM.viewWrapper, { height: loginHeight, duration: 0.4, ease: "power2.out" }, "<");

                DOM.headerTitle.innerText = "SYSTEM_GATEWAY";
                DOM.headerSub.innerText = "AUTHENTICATION REQUIRED";
            }
        }

        // --- 2. ЛОГИН ---
        async function handleLogin() {
            const loginInput = document.getElementById('login-email');
            const passwordInput = document.getElementById('login-pass');
            const email = loginInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                shakeCard();
                if(!email) loginInput.classList.add('error');
                if(!password) passwordInput.classList.add('error');
                setTimeout(() => {
                    loginInput.classList.remove('error');
                    passwordInput.classList.remove('error');
                }, 1000);
                return;
            }

            try {
                const formData = new URLSearchParams();
                formData.append('username', email);
                formData.append('password', password);

                const response = await fetch('/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                if (response.ok) {
                    const tokenData = await response.json();
                    localStorage.setItem('access_token', tokenData.access_token);
                    window.location.href = '/';
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Login failed');
                    shakeCard();
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Network error');
            }
        }

        // --- 3. STEPPER & REGISTER LOGIC ---
        const stepperState = { step: 1, total: 3 };
        const stepperEls = {
            slides: document.querySelectorAll('.step-slide'),
            indicators: document.querySelectorAll('.step-indicator .step-circle'),
            connector: document.getElementById('connector-fill'),
            wrapper: document.getElementById('steps-wrapper'),
            btnNext: document.getElementById('btn-next'),
            btnBack: document.getElementById('btn-back')
        };

        // --- VALIDATION HELPER ---
        function validateCurrentStep() {
            const currentSlide = document.querySelector(`.step-slide[data-step="${stepperState.step}"]`);
            const inputs = currentSlide.querySelectorAll('input');
            let isValid = true;
            let errorMsg = "";

            // 1. Проверка на пустоту
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    isValid = false;
                    input.classList.add('error');
                    input.addEventListener('input', () => input.classList.remove('error'), {once: true});
                }
            });

            // 2. Специфичная проверка для Шага 2 (Пароли)
            if (stepperState.step === 2 && isValid) {
                const p1Input = document.getElementById('reg-pass');
                const p2Input = document.getElementById('reg-confirm');
                const p1 = p1Input.value;
                const p2 = p2Input.value;

                // --- НОВАЯ ПРОВЕРКА ДЛИНЫ ---
                if (p1.length > 64) {
                    isValid = false;
                    errorMsg = "Password is too long (max 64 chars)";
                    p1Input.classList.add('error');
                }
                // Проверка на минимальную длину (тоже полезно)
                else if (p1.length < 8) {
                    isValid = false;
                    errorMsg = "Password too short (min 8 chars)";
                    p1Input.classList.add('error');
                }
                // Проверка на совпадение
                else if (p1 !== p2) {
                    isValid = false;
                    errorMsg = "Passwords do not match";
                    p2Input.classList.add('error');
                }
            }

            if (!isValid) {
                shakeCard();
                // Если есть текст ошибки, можно показать alert или вывести куда-то
                if (errorMsg) alert(errorMsg); 
            }
            return isValid;
        }

        function shakeCard() {
            gsap.to('#main-card', { x: [-5, 5, -5, 5, 0], duration: 0.3, ease: "none" });
        }

        function updateSummary() {
            // Берем данные из шага 1 и вставляем в шаг 3
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            document.getElementById('summary-name').innerText = name.toUpperCase();
            document.getElementById('summary-email').innerText = email;
        }

        async function handleRegisterSubmit() {
            const name = document.getElementById('reg-name').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-pass').value.trim();
            
            const role_name = "user";

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password, role_name })
                });

                if (response.ok) {
                    // После успешной регистрации логиним юзера
                    const formData = new URLSearchParams();
                    formData.append('username', email);
                    formData.append('password', password);

                    const loginResponse = await fetch('/token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData
                    });

                    if (loginResponse.ok) {
                        const tokenData = await loginResponse.json();
                        localStorage.setItem('access_token', tokenData.access_token);
                        window.location.href = '/';
                    } else {
                        alert('Registration OK but login failed. Please log in manually.');
                        window.location.href = '/login';
                    }
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Registration failed');
                    shakeCard();
                }
            } catch (e) {
                console.error('Register error:', e);
                alert('Network error');
            }
        }

        function updateIndicators() {
            const progress = ((stepperState.step - 1) / (stepperState.total - 1)) * 100;
            stepperEls.connector.style.width = `${progress}%`;
            stepperEls.indicators.forEach((circle, idx) => {
                const stepNum = idx + 1;
                circle.className = 'step-circle transition-all duration-300 border';
                circle.innerHTML = stepNum;
                if (stepNum < stepperState.step) {
                    circle.classList.add('bg-cyan-500', 'border-cyan-500', 'text-black', 'completed');
                    circle.innerHTML = `<svg class="checkmark w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>`;
                } else if (stepNum === stepperState.step) {
                    circle.classList.add('bg-cyan-900', 'border-cyan-400', 'text-cyan-400');
                } else {
                    circle.classList.add('bg-gray-900', 'border-white/10', 'text-white/30');
                }
            });
        }

        function goToStep(newStep) {
            const direction = newStep > stepperState.step ? 1 : -1;
            const currentSlide = document.querySelector(`.step-slide[data-step="${stepperState.step}"]`);
            const nextSlide = document.querySelector(`.step-slide[data-step="${newStep}"]`);

            if (!currentSlide || !nextSlide) return;

            // Если идем на 3 шаг, обновляем данные сводки
            if (newStep === 3) updateSummary();

            gsap.set(nextSlide, { autoAlpha: 1, position: 'absolute', zIndex: 10 });

            const slideHeight = nextSlide.offsetHeight;
            gsap.to(stepperEls.wrapper, { height: slideHeight, duration: 0.4, ease: "power2.out" });
            gsap.to(DOM.viewWrapper, { height: slideHeight + UI_OFFSET, duration: 0.4, ease: "power2.out" });

            gsap.to(currentSlide, { 
                x: direction > 0 ? '-100%' : '100%', autoAlpha: 0, duration: 0.4, ease: "power2.inOut",
                onComplete: () => gsap.set(currentSlide, { x: 0 })
            });

            gsap.fromTo(nextSlide, 
                { x: direction > 0 ? '100%' : '-100%', autoAlpha: 0 }, 
                { x: '0%', autoAlpha: 1, duration: 0.4, ease: "power2.inOut", onComplete: () => gsap.set(nextSlide, { zIndex: 1 }) }
            );

            if (newStep === 1) stepperEls.btnBack.style.opacity = '0.3';
            else stepperEls.btnBack.style.opacity = '1';

            // На последнем шаге меняем текст кнопки
            stepperEls.btnNext.innerText = newStep === stepperState.total ? 'CONFIRM & JOIN' : 'CONTINUE';
            
            stepperState.step = newStep;
            updateIndicators();
        }

        stepperEls.btnNext.addEventListener('click', () => {
            // Проверяем валидацию перед переходом
            if (!validateCurrentStep()) return;

            if (stepperState.step < stepperState.total) {
                goToStep(stepperState.step + 1);
            } else { 
                // Если это последний шаг, отправляем форму
                handleRegisterSubmit(); 
            }
        });

        stepperEls.btnBack.addEventListener('click', () => {
            if (stepperState.step > 1) goToStep(stepperState.step - 1);
        });

        window.addEventListener('load', () => {
            const loginH = DOM.loginView.scrollHeight + 20;
            DOM.viewWrapper.style.height = loginH + 'px';
            const firstStep = document.querySelector('.step-slide[data-step="1"]');
            if(firstStep) {
                gsap.set(firstStep, { autoAlpha: 1, position: 'absolute' });
                stepperEls.wrapper.style.height = firstStep.offsetHeight + 'px';
            }
        });
    </script>

    <script type="module">
        import { Renderer, Program, Mesh, Color, Triangle } from 'https://esm.sh/ogl';
        // (Твой существующий код шейдера aurora background без изменений)
        const VERT = `#version 300 es
        in vec2 position; void main() { gl_Position = vec4(position, 0.0, 1.0); }`;
        const FRAG = `#version 300 es
        precision highp float; uniform float uTime; uniform vec3 uColorStops[3]; uniform vec2 uResolution;
        out vec4 fragColor;
        vec3 permute(vec3 x) { return mod(((x * 34.0) + 1.0) * x, 289.0); }
        float snoise(vec2 v){ const vec4 C = vec4(0.211, 0.366, -0.577, 0.024); vec2 i=floor(v+dot(v,C.yy)); vec2 x0=v-i+dot(i,C.xx); vec2 i1=(x0.x>x0.y)?vec2(1.0,0.0):vec2(0.0,1.0); vec4 x12=x0.xyxy+C.xxzz; x12.xy-=i1; i=mod(i,289.0); vec3 p=permute(permute(i.y+vec3(0.0,i1.y,1.0))+i.x+vec3(0.0,i1.x,1.0)); vec3 m=max(0.5-vec3(dot(x0,x0),dot(x12.xy,x12.xy),dot(x12.zw,x12.zw)),0.0); m=m*m*m*m; vec3 x=2.0*fract(p*C.www)-1.0; vec3 h=abs(x)-0.5; vec3 ox=floor(x+0.5); vec3 a0=x-ox; m*=1.79-0.85*(a0*a0+h*h); vec3 g; g.x=a0.x*x0.x+h.x*x0.y; g.yz=a0.yz*x12.xz+h.yz*x12.yw; return 130.0*dot(m,g); }
        void main() {
            vec2 uv = gl_FragCoord.xy / uResolution;
            vec3 c1 = uColorStops[0]; vec3 c2 = uColorStops[1]; vec3 c3 = uColorStops[2];
            vec3 ramp = mix(c1, c2, smoothstep(0.0, 0.5, uv.x));
            ramp = mix(ramp, c3, smoothstep(0.5, 1.0, uv.x));
            float h = snoise(vec2(uv.x * 2.0 + uTime * 0.1, uTime * 0.25)) * 0.5;
            h = exp(h); h = (uv.y * 2.0 - h + 0.2);
            float i = 0.6 * h;
            float a = smoothstep(0.2 - 0.3, 0.2 + 0.3, i);
            fragColor = vec4(i * ramp * a, a);
        }
        `;
        const ctn = document.getElementById('aurora-container');
        const renderer = new Renderer({ alpha: true, premultipliedAlpha: true });
        const gl = renderer.gl; gl.clearColor(0,0,0,0);
        gl.canvas.style.width='100%'; gl.canvas.style.height='100%'; ctn.appendChild(gl.canvas);
        const program = new Program(gl, {
            vertex: VERT, fragment: FRAG,
            uniforms: {
                uTime: { value: 0 },
                uColorStops: { value: [new Color('#000000'), new Color('#22d3ee'), new Color('#1a1a2e')] },
                uResolution: { value: [window.innerWidth, window.innerHeight] }
            }
        });
        const mesh = new Mesh(gl, { geometry: new Triangle(gl), program });
        function resize() { renderer.setSize(window.innerWidth, window.innerHeight); program.uniforms.uResolution.value=[window.innerWidth, window.innerHeight]; }
        window.addEventListener('resize', resize); resize();
        requestAnimationFrame(function update(t) { program.uniforms.uTime.value=t*0.001*0.5; renderer.render({scene:mesh}); requestAnimationFrame(update); });
    </script>
</body>
</html>